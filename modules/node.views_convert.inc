<?php
//$Id: node.views_convert.inc,v 1.4 2009-03-24 22:14:27 merlinofchaos Exp $

/**
 * @file
 * Field conversion for fields handled by this module.
 */

/**
 * Implementation of hook_views_convert().
 *
 * Intervene to convert field values from the Views 1 format to the
 * Views 2 format. Intervene only if $view->add_item() won't produce
 * the right results, usually needed to set field options or values.
 */
function node_views_convert($display, $type, &$view, $field, $id = NULL) {
  switch ($field['tablename']) { // Avoid conflicts with fields in tables from other modules.
    case 'node':
      switch ($type) {
        case 'field':
          switch ($field['field']) {
            case 'title':
              $item = $view->get_item($display, 'field', $id);
              if ($field['options'] != 'no_link') {
                $item['link_to_node'] = TRUE;
              }
              $view->set_item($display, 'field', $id, $item);
              break;
            case 'body':
              $item = $view->get_item($display, 'field', $id);
              $item['table'] = 'node_revisions';
              $item['field'] = $field['handler'] == 'views_handler_field_teaser' ? 'teaser' : $item['field'];
              $view->set_item($display, 'field', $id, $item);
              break;
            case 'link':
              $field['field'] = 'view';
            case 'edit':
            case 'delete':
            case 'view':
              $item = $view->get_item($display, 'field', $id);
              $item['field'] = "$field[field]_node";
              if (!empty($field['options'])) {
                $item['text'] = $field['options'];
              }
              $view->set_item($display, 'field', $id, $item);
              break;
          }
          break;
        case 'filter':
          switch ($field['field']) {
            case 'type':
              $item = $view->get_item($display, 'filter', $id);
              $item['value'] = drupal_map_assoc($field['value']);
              $view->set_item($display, 'filter', $id, $item);
              break;
            case 'status':
            case 'promote':
            case 'sticky':
              $item = $view->get_item($display, 'filter', $id);
              $item['value'] = $field['value'];
              $view->set_item($display, 'filter', $id, $item);
              break;
          }
          break;
      }
      break;
  }
}
